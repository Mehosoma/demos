
var preloader = '<img src="/themes/zericheu/images/svg-loaders/tail-spin.svg" alt="">';
var stepLoader = $('#stepLoader');
var loading = $('#loader');
var prices, stocks = {};
var currentStock = '';
var currentTab = 'all';
var currentSector = 'all';
var currentType = 'Акции';
var clientOrder = '';
var priceModal;
var currentPriceRubls;
var buyStockForm = document.forms['buyStockForm'];
var currentPriceRublsRegExp = '';
var changeDay = '';
var tickerKey, ids = [];
getActiveStocks();


//список Активных акций для магазина акций
function getActiveStocks() {
    loading.show();
    $.ajax({
        url: 'stock/filter?active=1',
        type: 'GET',
        dataType: 'json',
        data: {},
        success: function (activeStocks) {
            const tickers=[];
            activeStocks.forEach((stock)=>tickers.push(stock.ticker));
            return getStocksApi(false,false,false,tickers);
        }
    });
}

// получить список акций для магазина акций. Без параметров возвращает весь список.
function getStocksApi(country, sector, type, tickers) {
    loading.show();
    $.ajax({
        url: '/proxyApi/getStocks2',
        type: 'POST',
        dataType: 'json',
        data: {
            Country: country ? country : 'all',
            Sector: sector ? sector : 'all',
            Types: type ? type : 'stocks',
            Tickers: tickers ? tickers : []
        },
        success: function (response) {
            stocks = response.Result;
            stocks.forEach((stock)=>ids.push(stock.Id));
            return renderStocks();
        }
    })
}

function getStockPriceIdeas() {
    $.ajax({
        url: '/proxyApi/getStockPrice',
        type: 'POST',
        dataType: 'json',
        data: {Ids: ids},
        success: function (response) {
            loading.hide();
            prices = response.Result;
            setBannersData(prices);
            return updateStockData(prices);
        }
    });
}

// интервал обновления данных по ценам и тд
setInterval(getStockPriceIdeas, 30000);


function setBannersData(prices) {
    prices.forEach(function (price) {
        if (price.Id === 27) { // AFLT
            $('.banner-one-val-up').html(price.FormattedPercentPlannedIncome);
            $('.banner-one-price').html(price.FormattedRubPrice);
            $('.banner-one-dividend').html(price.FormattedPercentDividendIncome);
        }
        if (price.Id === 38) { // ALRS
            $('.banner-two-val-up').html(price.FormattedPercentPlannedIncome);
            $('.banner-two-price').html(price.FormattedRubPrice);
            $('.banner-two-dividend').html(price.FormattedPercentDividendIncome);

        }
        if (price.Id === 42) { // PLZL
            $('.banner-three-val-up').html(price.FormattedPercentPlannedIncome);
            $('.banner-three-price').html(price.FormattedRubPrice);
            $('.banner-three-dividend').html(price.FormattedPercentDividendIncome);
        }

    });
}

function updateStockData(prices) {
    return prices.forEach(function (price) {

        var formattedRubPrice = price.FormattedRubPrice;
        var currencyRate = price.CurrencyRate;
        var plannedIncome = price.FormattedPercentPlannedIncome;
        var dirtyPrice = price.Price;
        var clearPrice = price.FormattedPrice;
        var dividentIncome = price.FormattedPercentDividendIncome;
        var changeDayDirty = price.FormattedPercentChange.replace(/(?!-)[^0-9.]/g, '');

        if (changeDayDirty > 0) {
            changeDay = '<span class="changeDay-item moneyUp">&nbsp(' + price.FormattedPercentChange + ')</span>';
        } else if (changeDayDirty < 0) {
            changeDay = '<span class="changeDay-item moneyDown">&nbsp(' + price.FormattedPercentChange + ')</span>';
        }
        $('#changeDay' + price.Id).html(changeDay);
        $('#PercentPlannedIncome' + price.Id).html(plannedIncome ? plannedIncome : $('.plannedIncome' + price.Id).add('#PercentPlannedIncome' + price.Id).hide());


        var $priceId = $('#price' + price.Id);
        var $buttonPriceId = $('#button' + price.Id);
        var $dividendPriceId = $('#dividend' + price.Id);
        var $formattedRubPrice = $('#rubPrice' + price.Id);
        var $currencyRate = $('#currencyRate' + price.Id);

        $priceId.html(dirtyPrice ? dirtyPrice : $buttonPriceId.hide());
        $priceId.html(clearPrice ? clearPrice : $buttonPriceId.hide());
        $dividendPriceId.html(dividentIncome ? dividentIncome : $dividendPriceId.add('.dividend' + price.Id).hide());
        $formattedRubPrice.html(formattedRubPrice);
        $currencyRate.html(currencyRate);
    })
}

// показываем блоки с акциями
var elem = 12; // количество акций при загрузке
var step = 1; // шаг
var template = [];
var listButton = $(".list-view");
var gridButton = $(".grid-view");
var wrapper = $(".wrapper");

function renderStocks() {
    tickerKey = stocks;
    $('.stock').remove();
    var q = 0;
    stocks.forEach(function (stock) {
        q++;
        this.stock = stock;
        if (((step * elem - elem) < q && q <= (step * elem)) && (currentType==='bonds')) {
            template += '<tr class="stock">';
            template += '<td class="stocks-image"><a href="/stocks/bond?Ticker=' + stock.Ticker + '.html"><img src="/images/stocks/' + stock.Ticker + '.png" alt="акции ' + stock.Ticker + '"><span class="stock-shortName">' + stock.ShortName + '</span></a></td>';
            template += '<td data-href="/stocks/bond?Ticker=' + stock.Ticker + '.html" class="share-value share-property-dividend">' + stock.YIELD + "%" + '</td>';
            // template += '<td data-href="/stocks/bond?Ticker=' + stock.Ticker + '.html" class="share-value green percent-planned-income">' + stock.COUPONVALUE + " ₽" + '</td>';
            template += '<td data-href="/stocks/bond?Ticker=' + stock.Ticker + '.html"><div class="price-changeDay"><span id="price' + stock.Id + '" class="share-value share-price">' + preloader + '</span></div></td>';
            template += '<td style="display: none"  id="rubPrice' + stock.Id + '" class="share-value">' + preloader + '</td>';
            template += '<td style="display: none"  id="currencyRate' + stock.Id + '" class="share-value">' + preloader + '</td>';
            template += '</tr>';
        } else {
            if ((step * elem - elem) < q && q <= (step * elem)) {
                template += '<tr class="stock">';
                template += '<td class="stocks-image"><a href="/stocks/stock?Ticker=' + stock.Ticker + '.html"><img src="/images/stocks/' + stock.Ticker + '.png" alt="акции ' + stock.Ticker + '"><span class="stock-shortName">' + stock.ShortName + '</span></a></td>';
                template += '<td data-href="/stocks/stock?Ticker=' + stock.Ticker + '.html" id="dividend' + stock.Id + '" class="share-value share-property-dividend">' + preloader + '</td>';
                template += '<td data-href="/stocks/stock?Ticker=' + stock.Ticker + '.html" id="PercentPlannedIncome' + stock.Id + '" class="share-value green percent-planned-income">' + preloader + '</td>';
                template += '<td data-href="/stocks/stock?Ticker=' + stock.Ticker + '.html"><div class="price-changeDay"><span id="price' + stock.Id + '" class="share-value share-price">' + preloader + '</span><span id="changeDay' + stock.Id + '" class="changeDay-item">' + preloader + '</span></div></td>';
                template += '<td style="display: none"  id="rubPrice' + stock.Id + '" class="share-value">' + preloader + '</td>';
                template += '<td style="display: none"  id="currencyRate' + stock.Id + '" class="share-value">' + preloader + '</td>';
                // template += '<td><a id="button' + stock.Id + '" class="btn stock-popup" href="#popUp" id="openPopUp">Купить</a></td>'; // если надо будет вернуть попап
                // template += '<td><a id="button' + stock.Id + '" class="btn stock-popup" href="/registration" >Купить</a></td>';
                // template += '<td><a id="button' + stock.Id + '" class="stock-link" href="/stocks/stock?Ticker=' + stock.Ticker + '.html" >Подробнее</a></td>';
                template += '</tr>';
            }
        }
    });
    // Сортировка/Фильтр
    var currentContainer = $('#table-stocks');
    currentTab === 'rus' ? currentContainer = $('#table-stocks-rus') : currentContainer;
    currentTab === 'usa' ? currentContainer = $('#table-stocks-usa') : currentContainer;


    currentContainer.append(template);

    listButton.on("click", function () {
        gridButton.removeClass("on");
        listButton.addClass("on");
        wrapper.removeClass("grid").addClass("list");
    });

    gridButton.on("click", function () {
        listButton.removeClass("on");
        gridButton.addClass("on");
        wrapper.removeClass("list").addClass("grid");
    });

    var setStockPopupIndex = this.test = document.getElementsByClassName('stock-popup');

    for (var counter = 0; counter < setStockPopupIndex.length; counter++) {
        index = Array.prototype.indexOf.call(setStockPopupIndex, setStockPopupIndex[counter]);
        setStockPopupIndex[counter].setAttribute('index', index); // добавляем в ДОМ атрибут - index
        setStockPopupIndex[counter].onclick = showStockModal;
    }
    return getStockPriceIdeas();
}

// сортировка по акциям  use .each() to call function for each nav-item-tab row
$('.nav-item-tab').each(function () {
    var $navItemTab = $(this);
    $navItemTab.on('click', function () {
        step = 1;
        template = [];
    });
});

// кнопка показать еще
$('.btn-load-more').on('click', function () {
    step++;
    renderStocks(stocks);
});

/** Magic link as tr **/
$(document).on('click', 'td[data-href]', function () {
    document.location = $(this).data('href');
    return false;
});

/** Custom Search **/
$(".search-input, #search-mobile").keyup(function () {
    var search = $(this).val();
    if (search.length > 1) {
        $.ajax({
            type: 'POST',
            url: '/stocks/filter?search=' + search,
            data: {},
            dataType: 'json',
            success: function (data) {
                tickerKey.forEach(function (stock) {
                    $.each(data, function (key, value) {
                        $('.stock').remove();
                        if (value.ticker === stock.Ticker) {

                            template = [];
                            template += '<tr class="stock">';
                            template += '<td class="stocks-image"><a  href="/stocks/stock?Ticker=' + stock.Ticker + '.html"><img src="/images/stocks/' + stock.Ticker + '.png" alt="акции ' + stock.Ticker + '"><span class="stock-shortName">' + stock.ShortName + '</span></a></td>';
                            template += '<td id="PercentPlannedIncome' + stock.Id + '" class="share-value green percent-planned-income">' + preloader + '</td>';
                            template += '<td id="dividend' + stock.Id + '" class="share-value share-property-dividend">' + preloader + '</td>';
                            template += '<td><span id="price' + stock.Id + '" class="share-value share-price">' + preloader + '</span><span id="changeDay' + stock.Id + '" class="changeDay-item">' + preloader + '</span></td>';
                            template += '<td style="display: none"  id="rubPrice' + stock.Id + '" class="share-value">' + preloader + '</td>';
                            template += '<td style="display: none"  id="currencyRate' + stock.Id + '" class="share-value">' + preloader + '</td>';
                            // template += '<td><a id="button' + stock.Id + '" class="btn stock-popup" href="/stocks/stock?Ticker=' + stock.Ticker + '.html" id="openPopUp">Купить</a></td>';
                            // template += '<td><a id="button' + stock.Id + '" class="stock-link" href="/stocks/stock?Ticker=' + stock.Ticker + '.html" >Подробнее</a></td>';
                            template += '</tr>';
                            getStockPriceIdeas();

                        }
                        var currentContainer = $('#table-stocks');
                        currentContainer.append(template);
                        $('.btn-load-more').hide();

                    });

                });
            }
        });
    }
    /** Return default State **/
    if (search.length === 0) {
        template = [];
        $('.btn-load-more').show();
        return renderStocks(stocks);
    }
});

/** Animation Search **/
function searchToggle(obj, evt) {
    var container = $(obj).closest('.search-wrapper');
    if (!container.hasClass('active')) {
        container.addClass('active');
        evt.preventDefault();
    }
    else if (container.hasClass('active') && $(obj).closest('.input-holder').length === 0) {
        container.removeClass('active');
        container.find('.search-input').val('');
    }
}

/** Focus on Search **/
$("#search-button").click(function () {
    $("#search-input").focus();
    $('.toggle-options-btn').hide();

});

$("#search-input").focusout(function () {
    $('.search-wrapper').removeClass('active');
    $('.toggle-options-btn').show();
});

$('#buyStockForm').keypress(function (event) {
    if (event.keyCode === 10 || event.keyCode === 13)
        event.preventDefault();
});


/** Custom Select **/
$(".custom-select").each(function () {
    var classes = $(this).attr("class"),
        id = $(this).attr("id"),
        name = $(this).attr("name");
    var template = '<div class="' + classes + '">';
    template += '<span class="custom-select-trigger">' + $(this).attr("placeholder") + '</span>';
    template += '<div class="custom-options" >';
    $(this).find("option").each(function () {
        var self = this;
        template += '<span class="custom-option data-value-option ' + self.value + '" data-value="' + $(this).attr("value") + '">' + $(this).html() + '</span>';
    });
    template += '</div></div>';

    $(this).wrap('<div class="custom-select-wrapper"></div>');
    $(this).hide();
    $(this).after(template);
});
$(".custom-option:first-of-type").hover(function () {
    $(this).parents(".custom-options").addClass("option-hover");
}, function () {
    $(this).parents(".custom-options").removeClass("option-hover");
});
$(".custom-select-trigger").on("click", function () {
    $('html').one('click', function () {
        $(".custom-select").removeClass("opened");
    });
    $(this).parents(".custom-select").toggleClass("opened");
    event.stopPropagation();
});
$(".custom-option").on("click", function () {
    $(this).parents(".custom-select-wrapper").find("select").val($(this).data("value"));
    $(this).parents(".custom-options").find(".custom-option").removeClass("selection");
    $(this).addClass("selection");
    $(this).parents(".custom-select").removeClass("opened");
    $(this).parents(".custom-select").find(".custom-select-trigger").text($(this).text());
});

/** Sort Select Sectors **/
function changeSector(sector) {
    if ($('#nav-tab-all')[0].checked === true) {
        template = [];
        return getStocksApi('all', sector, false, false);
    } else if ($('#nav-tab-rus')[0].checked === true) {
        template = [];
        return getStocksApi('rus', sector, false, false);
    } else if ($('#nav-tab-usa')[0].checked === true) {
        template = [];
        return getStocksApi('usa', sector, false, false);
    }
}

/** Magic choose data value **/
$('.data-value-option').on('click', function () {
    var test = $(".custom-options").find('.selection');
    return changeSector(test[0].dataset.value);
});

